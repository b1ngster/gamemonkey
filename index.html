
<!doctype html>
<html lang="en">
<head>
	<title>Game Monkey </title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel=stylesheet href="styles/core.css"/>
    
<style>
#my-gui-container {
	position: absolute;
    left: 50%;  /* position inside relatively positioned parent */
	bottom: 5%;
    z-index: 0;   /* adjust as needed */
}
#my-gui-container .dg .main ul{
    display:inline;
 
}
#my-gui-container .dg ul {
    list-style: none;
    margin: 0;
    padding: 20%;
    width: 100%;
    float: left
}
#my-gui-container .dg ul li{
    list-style: none;
    
    float: left
}
#overlay {
	position: absolute;
	z-index: 2;
	top: 0;
	left: 0;
	width: 100%;
	height:100%;
	display: flex;
	align-items: center;
	justify-content: center;
	opacity: 1;
	background-color: #000000;
	color: #ffffff;
}

#overlay > div {
	text-align: center;
}

#overlay > div > button {
	height: 20px;
	background: transparent;
	color: #ffffff;
	outline: 1px solid #ffffff;
	border: 0px;
	cursor: pointer;
    margin-top: 4em;
}

#overlay > div > p {
	color: #777777;
	font-size: 12px;
}
</style>


</head>
<body  >

    <script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/three.js"></script>
    <script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/Detector.js"></script>
     <!--
    <script src="js/extras/Stats.js"></script>
   
    <script src="js/controls/OrbitControls.js"></script>
      -->
    <script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/extras/threex.keyboardstate.js"></script>
  <!--
    <script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/extras/THREEx.FullScreen.js"></script>
 
-->
<script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/extras/threex.windowresize.js"></script>
    <script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/axios/dist/axios.js"></script>

    <!-- jQuery code to display an information button and box when clicked. -->
    <script src="https://fdsc-intmeddev.blackpool.ac.uk/67551/js/jquery-3.4.1.min.js"></script>
   
    <!--
    <link rel=stylesheet href="css/jquery-ui.css" />
    <link rel=stylesheet href="css/info.css"/>
    <script src="js/info.js"></script>
     -->

     
		<div id="overlay">
			<div>
                <form>
                    Your Name   <input type="text" name="username" id="username"></input></form>
                </form>
				<button id="startButton">Click to Play</button>
				
			</div>
		</div>

    <div id="infoButton"></div>
    

    <div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>
   
   <div id="my-gui-container"></div>
   
   <script>
      
        var container, scene, camera, renderer, controls, stats;
    
        var keyboard = new THREEx.KeyboardState();
      /*  THREEx.FullScreen.bindKey({ charCode: 'f'.charCodeAt(0) });
      
      */
        // custom global variables
        var video, videoImage, videoImageContext, videoTexture;
        var startButton = document.getElementById( 'startButton' );
			startButton.addEventListener( 'click', function () {
               
        var usernameField = document.getElementById('username');
        console.log(usernameField.value);
            if(usernameField.value !==""){
                console.log(usernameField.value);
                user.username = usernameField.value;
                console.log(user);
            var overlay = document.getElementById( 'overlay' );
            console.log(overlay);
				overlay.remove();
            // SCENE
           

				init();
				animate();
            
            }
            }, false );
            
            var callback_progress = function( progress, result ) {
				
                var bar = 250, 
                total = progress.total_models + progress.total_textures,
                loaded = progress.loaded_models + progress.loaded_textures;
                
                if ( total )
                    bar = Math.floor( bar * loaded / total );
                
                $( "bar" ).style.width = bar + "px";
                
                count = 0;
                for ( var m in result.materials ) count++;

                handle_update( result, Math.floor( count/total ) );
                
            }
            
            raycaster = new THREE.Raycaster();
            mouseVector = new THREE.Vector2();
            container = document.getElementById('ThreeJS');

          var  user = { username: "",
                        current_question: 0,
                        current_video: 1,
                        score: 0,
                        answers: []
                        }
       
  // FUNCTIONS

  var scenes = {

"1" : { 
question: 'assets/question_1/countdown.mp4',
answer_a: 'assets/question_1/A.ogv',
answer_b: 'assets/question_1/B.ogv',
answer_c: 'assets/question_1/C.ogv',
answer_d: 'assets/question_1/D.ogv'
}
};



function loadJSON(url, callback) {   

var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
xobj.open('GET', url, true); // Replace 'my_data' with the path to your file
xobj.onreadystatechange = function () {
      if (xobj.readyState == 4 && xobj.status == "200") {
        // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
        callback(xobj.responseText);
      }
};
xobj.send(null);  
}
 function get_question() {
  var json;
    var data;
    loadJSON("js/questionbank.json", function(response) {
        json = JSON.parse(response);
        // Call another function with json that is now filled with data
        handleJson(json);
    });


function handleJson(json) {
   return this.data = json;
}

return this.data;

 }

  var scene = {};

        function init() {

           

            scene = new THREE.Scene();
          

            // https://threejsfundamentals.org/threejs/lessons/threejs-fundamentals.html
            var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
            var VIEW_ANGLE = 45,
                ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT,
                NEAR = 0.1,
                FAR = 1000,
                FLOOR = 40
                ;
            
  
            camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
            
            //
            
            window.addEventListener( 'click', onClick, false );
          
            // RENDERER

            renderer = new THREE.WebGLRenderer({ antialias: true });

            renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
            renderer.setPixelRatio( window.devicePixelRatio );
           
            container.appendChild(renderer.domElement);
            
            // CONTROLS
           // controls = new THREE.OrbitControls(camera, renderer.domElement);
            // EVENTS
            THREEx.WindowResize(renderer, camera);
           // STATS
          //  stats = new Stats();
          /*
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.bottom = '0px';
            stats.domElement.style.zIndex = 100;
            container.appendChild(stats.domElement);
            */

            // LIGHT
            var light_1 = new THREE.PointLight(0xffffff);
            light_1.position.set(0, 250, 0);
            scene.add(light_1);
            
            var light_2 = new THREE.PointLight(0xffffff);
            light_2.position.set(0, 0, 200);
            scene.add(light_2);

            


            // SKYBOX 
            var skyBoxGeometry = new THREE.CubeGeometry(10000, 10000, 10000);
            var skyBoxMaterial = new THREE.MeshBasicMaterial({ color: 0x9999ff, side: THREE.BackSide });
            var skyBox = new THREE.Mesh(skyBoxGeometry, skyBoxMaterial);
            scene.add(skyBox);
            scene.fog = new THREE.FogExp2(0x9999ff, 0.00025);

            // create the video element
            video = document.createElement('video');
             video.id = 'intro';
            // video.type = ' video/ogg; codecs="theora, vorbis" ';
            video.src = "videos/intro.ogv";
            video.load(); // must call after setting/changing source
            video.muted = true;
            video.play();
            
          
            videoImage = document.createElement('canvas');
            videoImage.width = 1920;
            videoImage.height = 1080;

            videoImageContext = videoImage.getContext('2d');
            // background color if no video present
            videoImageContext.fillStyle = '#000000';
            videoImageContext.fillRect(0, 0, videoImage.width, videoImage.height);

            videoTexture = new THREE.VideoTexture(videoImage);
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;

            var movieMaterial = new THREE.MeshBasicMaterial({ map: videoTexture,  side: THREE.DoubleSide });
            // the geometry on which the movie will be displayed;
            // 		movie image will be scaled to fit these dimensions.
            var movieGeometry = new THREE.PlaneGeometry(480, 230, 4, 4);
            var movieScreen = new THREE.Mesh(movieGeometry, movieMaterial);
            movieScreen.position.set(0, 10, 0);
            scene.add(movieScreen);


            camera.position.set(0, 0, 300);
            camera.lookAt(movieScreen.position);

           

        }
          
        
        function onClick (e){

            e.preventDefault();
           
            var mouseVector = new THREE.Vector3(
                ( e.clientX / window.innerWidth ) * 2 - 1,
            - ( e.clientY / window.innerHeight ) * 2 + 1,
                1 );

            //projector.unprojectVector( mouseVector, camera );
            var raycaster = new THREE.Raycaster();

            raycaster.setFromCamera( mouseVector, camera );
            // create an array containing all objects in the scene with which the ray intersects
            var intersects = raycaster.intersectObjects( scene.children );

       
       // Handle button clicks
            if (intersects.length>0){
    

    if(intersects[0].object.name == "button_a"){
        
       Quiz("a")
    }
    if(intersects[0].object.name == "button_b"){
        Quiz("b")
    }
    if(intersects[0].object.name == "button_c"){
        Quiz("c")
    }
    if(intersects[0].object.name == "button_d"){
        Quiz("d")
    }

}
        }


        function animate() {
            requestAnimationFrame(animate);
            render();
            update();
        }
        var intro_complete = 0;

        function update() {
          
            if(intro_complete == 0){
                intro_complete= 1;
                
            }
            if(video.ended && intro_complete == 1){
                intro_complete = 2;
                Quiz(scenes["1"].question);
            }
        

            //controls.update();
           // stats.update();
        }

        function render() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                videoImageContext.drawImage(video, 0, 0);
                if (videoTexture)
                    videoTexture.needsUpdate = true;
            }

            renderer.render(scene, camera);
        }


/*contains logic for quiz

*/

    function Quiz(button_clicked ){
                
               const  questionBank = get_question();
               
           
           /*.then((values)=>{
             question_data = values.data.questions;
           });
           */
          // var user.current_questio = 10 //Math.floor(Math.random() * 10 + 1);
           //console.log()
       
           

          if(user.current_question == 0){
           
            videopath = "videos/questions/question_1/question.mp4";
            video = renderVideo(videopath);
            axios.post('gamedata.php', {
                        user })
                    .then((response) => {
                    console.log(response);
                    }, (error) => {
                    console.log(error);
                    });
            video.addEventListener("ended", videoEnded); 

            function videoEnded(){
            	window.location.reload(true);
            }
            renderButtons();
             
          }

          if(questionBank){
          var QBank = questionBank.questions[user.current_question]
         
         
          var answer = QBank.correct;
          if( answer != undefined)
           if( answer.substr(-1) == button_clicked){
            user.current_video++;
            user.current_question++;
            user.score += 10;
            user.answers.push([user.current_video, button_clicked])

            axios.post('gamedata.php', {
                    user
                })
                .then((response) => {
                console.log(response);
                }, (error) => {
                console.log(error);
                });
            //0 indexed array 
            

            
           videopath = "./videos/questions/question.mp4";
            //console.log(videopath);
           // videopath = "videos/questions/fail.mp4"
           if(user.current_question == 10){
            videopath = "videos/questions/win.mp4";
          
            }
            var video = renderVideo(videopath);
            video.addEventListener("ended", videoEnded); 

			function videoEnded(){
				window.location.reload(true);
            }
            var buttons = renderButtons(user.current_question);
            
            }else{
                removeGui();
                clearScene();
                videopath = "videos/questions/fail.mp4"
                var video = renderVideo(videopath);
               
                video.addEventListener("ended", videoEnded); 

			function videoEnded(){
			//	window.location.reload();
            }
        }
    }
        /*
          ///button check A
          if(button_clicked == 'a'){
            videopath = `/videos/questions/question_${user.current_video}/A.ogv`;
           console.log(videopath);
            var video = renderVideo(videopath);
            if(video.ended){
                console.log('ended');
            }
            console.log(user.current_question);
            console.log(questionBank.questions[user.current_question]);
          
          /*
            if(questionBank.questions[user.current_question].correct
           .substr(-1) !== 'a'){
               console.log('incorrect');
           }else{
               console.log('correct')
           }
         //  user.current_question++;
         //  user.current_video++;
           renderButtons();
          }

          //button check B
          if(button_clicked == 'b'){

            videopath = `/videos/questions/question_${user.current_video}/B.ogv`;
            var video = renderVideo(videopath);
           
            if(questionBank.questions[user.current_question].correct
                    .substr(-1) !== 'b'){
               console.log('incorrect');
           }else{
               console.log('correct')
           }
          //  user.current_question++;
          //  user.current_video++;
            renderButtons();
          } 


          if(button_clicked == 'c'){
            //videopath = '`/videos/questions/question_${user.current_video}/C.ogv`;
           // videopath = "/videos/questions/fail.mp4"
            user.current_question;
            var video = renderVideo(videopath);
            if(questionBank.questions[user.current_question]
                    && questionBank.questions[user.current_question].correct.substr(-1) == 'c'){
               console.log('incorrect');
           }else{
               console.log('correct')
           }
          // user.current_question++;
           //user.current_video++;
          
          }
          if(button_clicked == 'd'){
           
            videopath = `/videos/questions/question_${user.current_video}/D.ogv`;
            var video = renderVideo(videopath);
            if(questionBank.questions[user.current_question].correct 
            .substr(-1) !== 'd'){
               console.log('incorrect');
           }else{
               console.log('correct')
           }
           // user.current_question++;
          //  user.current_video++;
            console.log(user);
           
          }
          */
      
         if( user.current_question === 1 ){
         
         
          
         //renderVideo(user.current_video);
         }
       //  renderButtons(user.current_video);
          /*
            var loader = new THREE.FontLoader();

    loader.load( 'js/fonts/helvetiker_bold.typeface.json', function ( font ) {

    var textGeo = new THREE.TextGeometry( currentQuestion, {
        font: font,
        size: 6,
        height: 2,
        curveSegments: 12,
        } );

    var  textMaterial = new THREE.MeshStandardMaterial( {
					color: 0xffffff,
                    flatShading: true,

				} );
    var mesh = new THREE.Mesh( textGeo, textMaterial );
    mesh.position.set(-80, -40, 20);
    

    scene.add( mesh );

} );
*/

    


        }
    

        function renderVideo(videopath){

         //   video.pause();
            video.src = videopath;
            video.load(); // must call after setting/changing source
        
            video.play();
            videoImage = document.createElement('canvas');
            videoImage.width = 1920;
            videoImage.height = 1080;

            videoImageContext = videoImage.getContext('2d');
            // background color if no video present
            videoImageContext.fillStyle = '#000000';
            videoImageContext.fillRect(0, 0, videoImage.width, videoImage.height);

            videoTexture = new THREE.VideoTexture(videoImage);
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;

            var movieMaterial = new THREE.MeshBasicMaterial({ map: videoTexture,  side: THREE.DoubleSide });
            // the geometry on which the movie will be displayed;
            // 		movie image will be scaled to fit these dimensions.
            var movieGeometry = new THREE.PlaneGeometry(480, 230, 4, 4);
            var movieScreen = new THREE.Mesh(movieGeometry, movieMaterial);
            movieScreen.position.set(0, 10, 0);
            scene.add(movieScreen);
            
            return video;
        }

        function renderButtons(){

            console.log(user);

            var ButtonA_tex = new THREE.TextureLoader().load(`assets/buttons/question_${user.current_video}/question_${user.current_video}_option_a.png`);
            var ButtonB_tex = new THREE.TextureLoader().load(`assets/buttons/question_${user.current_video}/question_${user.current_video}_option_b.png`);
            var ButtonC_tex = new THREE.TextureLoader().load(`assets/buttons/question_${user.current_video}/question_${user.current_video}_option_c.png`);
            var ButtonD_tex = new THREE.TextureLoader().load(`assets/buttons/question_${user.current_video}/question_${user.current_video}_option_d.png`);
           
            var gui_question_tex = new THREE.TextureLoader().load(`assets/buttons/question_${user.current_video}/question_${user.current_video}.png`);
            var gui_question_material = new THREE.MeshBasicMaterial({ map: gui_question_tex, side: THREE.DoubleSide });
           
            var gui_question_geometry = new THREE.PlaneGeometry(300, 30, 10, 10);
            var gui_question_mesh = new THREE.Mesh(gui_question_geometry, gui_question_material);
          
            gui_question_mesh.position.set(0, -40, 20);
            gui_question_mesh.name ="gui_question";
            
         
            var button_A_Material = new THREE.MeshBasicMaterial({ map: ButtonA_tex, side: THREE.DoubleSide });
            var button_B_Material = new THREE.MeshBasicMaterial({ map: ButtonB_tex, side: THREE.DoubleSide });
            var button_C_Material = new THREE.MeshBasicMaterial({ map: ButtonC_tex, side: THREE.DoubleSide });
            var button_D_Material = new THREE.MeshBasicMaterial({ map: ButtonD_tex, side: THREE.DoubleSide });
        
           
            //width height and wsegment hsegments
            var buttonGeometry = new THREE.PlaneGeometry(60, 40, 10, 10);
            
            var buttonA = new THREE.Mesh(buttonGeometry, button_A_Material);
            var buttonB = new THREE.Mesh(buttonGeometry, button_B_Material);
            var buttonC = new THREE.Mesh(buttonGeometry, button_C_Material);
            var buttonD = new THREE.Mesh(buttonGeometry, button_D_Material);
          
            
          
          
            //buttonA.position.z = 0.5; //Math.PI / 2;
            //buttonA.rotation.x = Math.PI / 2;
            buttonA.position.set(-100, -80, 20);
            buttonA.name ="button_a";
            
            buttonB.position.set(-35, -80, 20);
            buttonB.name ="button_b";

            buttonC.position.set(35, -80, 20);
            buttonC.name ="button_c";

            buttonD.position.set(100, -80, 20);
            buttonD.name ="button_d";

            scene.add(gui_question_mesh);
            scene.add(buttonA);
            scene.add(buttonB);
            scene.add(buttonC);
            scene.add(buttonD);

        }
        function removeGui(){
            console.log(scene);
            var elem = scene.getObjectByName("gui_question", true);
            scene.remove(elem);
            scene.remove(scene.getObjectByName("button_a"));
            scene.remove(scene.getObjectByName("button_b"));
            scene.remove(scene.getObjectByName("button_c"));
            scene.remove(scene.getObjectByName("button_d"));
            console.log(scene);
        }
        function clearScene(){
            while(scene.children.length > 0){ 
    scene.remove(scene.children[0]); 
}
        }

      

   //     init();
   //     animate();
</script>
</body>
</html>
